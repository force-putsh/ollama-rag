package org.rag_sys.agent;

import org.rag_sys.config.RagConfiguration;
import org.rag_sys.factory.ServiceFactory;
import org.rag_sys.model.DocumentAnalyser;

import java.net.URISyntaxException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicLong;

/**
 * Routeur d'agents qui g√®re la distribution des questions aux agents sp√©cialis√©s
 * avec m√©triques de performance et gestion d'erreurs am√©lior√©e
 */
public class AgentRouter {
    
    private final Map<AgentType, Agent> agents;
    private final GuardAgentImpl guardAgent;
    private final RagConfiguration configuration;
    
    // M√©triques de performance
    private final AtomicInteger totalQuestions = new AtomicInteger(0);
    private final AtomicInteger rejectedQuestions = new AtomicInteger(0);
    private final AtomicLong totalProcessingTime = new AtomicLong(0);
    private final Map<AgentType, AtomicInteger> agentUsageCount = new HashMap<>();
    private LocalDateTime startTime;
    
    public AgentRouter(RagConfiguration configuration) {
        this.configuration = configuration;
        this.agents = new HashMap<>();
        this.guardAgent = new GuardAgentImpl(configuration.getModelName(), configuration.getOllamaBaseUrl());
        this.startTime = LocalDateTime.now();
        
        // Initialiser les compteurs d'usage pour chaque type d'agent
        for (AgentType type : AgentType.values()) {
            agentUsageCount.put(type, new AtomicInteger(0));
        }
        
        System.out.println("üîß AgentRouter initialis√© avec l'agent de garde");
    }

    /**
     * Enregistre un agent sp√©cialis√©
     */
    private void registerAgent(AgentType type, Agent agent) {
        agents.put(type, agent);
        System.out.println("Agent " + type.getCode() + " enregistr√© avec succ√®s.");
    }
    
    /**
     * Enregistre un agent en cr√©ant automatiquement sa cha√Æne RAG
     */
    public void registerAgent(AgentType type, String documentDirectory, ServiceFactory serviceFactory) {
        try {
            System.out.println("Cr√©ation de l'agent " + type.getCode() + " avec le r√©pertoire: " + documentDirectory);
            
            DocumentAnalyser documentAnalyser = createAgentDocumentAnalyser(documentDirectory, serviceFactory);
            
            if (documentAnalyser != null) {
                Agent agent = new SpecializedAgent(type, documentAnalyser);
                registerAgent(type, agent);
            } else {
                System.err.println("√âchec de la cr√©ation de l'agent " + type.getCode());
            }
            
        } catch (Exception e) {
            System.err.println("Erreur lors de l'enregistrement de l'agent " + type.getCode() + ": " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Route une question vers l'agent appropri√© avec m√©triques de performance
     */
    public String routeQuestion(String question) {
        long startTime = System.currentTimeMillis();
        totalQuestions.incrementAndGet();
        
        try {
            // 1. Analyser la question avec l'agent de garde
            QuestionAnalysisResult analysis = guardAgent.analyzeQuestion(question);
            System.out.println("üìä R√©sultat de l'analyse: " + analysis);
            
            // 2. V√©rifier si la question doit √™tre trait√©e
            if (!analysis.shouldProcess()) {
                rejectedQuestions.incrementAndGet();
                return formatRejectionResponse(analysis);
            }
            
            // 3. Obtenir l'agent recommand√©
            AgentType recommendedType = analysis.getRecommendedAgent();
            Agent recommendedAgent = agents.get(recommendedType);
            
            if (recommendedAgent == null || !recommendedAgent.isReady()) {
                return formatAgentUnavailableResponse(recommendedType);
            }
            
            // 4. Incr√©menter les statistiques d'usage
            agentUsageCount.get(recommendedType).incrementAndGet();
            
            // 5. Traiter la question avec l'agent sp√©cialis√©
            System.out.println("üöÄ Routage vers l'agent " + recommendedType.getCode().toUpperCase());
            String response = recommendedAgent.processQuestion(question);
            
            // 6. Formater la r√©ponse avec des informations de contexte
            return formatSuccessResponse(analysis, response);
            
        } catch (Exception e) {
            System.err.println("‚ùå Erreur lors du routage de la question: " + e.getMessage());
            e.printStackTrace();
            return formatErrorResponse(e);
        } finally {
            // Enregistrer le temps de traitement
            long processingTime = System.currentTimeMillis() - startTime;
            totalProcessingTime.addAndGet(processingTime);
            System.out.println("‚è±Ô∏è Temps de traitement: " + processingTime + "ms");
        }
    }
    
    /**
     * Retourne les statistiques d√©taill√©es des agents et de performance
     */
    public String getAgentStats() {
        StringBuilder stats = new StringBuilder();
        stats.append("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n");
        stats.append("‚ïë                    üìä STATISTIQUES D√âTAILL√âES                ‚ïë\n");
        stats.append("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n");
        
        // Statistiques g√©n√©rales
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm:ss");
        stats.append(String.format("‚ïë üïê D√©marrage syst√®me: %s     ‚ïë\n", startTime.format(formatter)));
        stats.append(String.format("‚ïë üìù Questions trait√©es: %-5d                           ‚ïë\n", totalQuestions.get()));
        stats.append(String.format("‚ïë ‚ùå Questions rejet√©es: %-5d                            ‚ïë\n", rejectedQuestions.get()));
        
        if (totalQuestions.get() > 0) {
            double rejectionRate = (double) rejectedQuestions.get() / totalQuestions.get() * 100;
            double avgProcessingTime = (double) totalProcessingTime.get() / totalQuestions.get();
            stats.append(String.format("‚ïë üìä Taux de rejet: %.1f%%                              ‚ïë\n", rejectionRate));
            stats.append(String.format("‚ïë ‚ö° Temps moyen: %.0f ms                              ‚ïë\n", avgProcessingTime));
        }
        
        stats.append("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n");
        stats.append("‚ïë                        ü§ñ √âTAT DES AGENTS                    ‚ïë\n");
        stats.append("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n");
        
        // Statistiques des agents
        for (AgentType type : AgentType.values()) {
            if (type == AgentType.GUARD) continue; // Skip l'agent de garde dans cette liste
            
            Agent agent = agents.get(type);
            int usage = agentUsageCount.get(type).get();
            
            if (agent != null) {
                String status = agent.isReady() ? "‚úÖ Actif" : "‚ö†Ô∏è Indisponible";
                stats.append(String.format("‚ïë %s %-6s: %s (Utilis√©: %-3d fois)         ‚ïë\n", 
                    getAgentEmoji(type), type.getCode().toUpperCase(), status, usage));
            } else {
                stats.append(String.format("‚ïë %s %-6s: ‚ùå Non enregistr√©                    ‚ïë\n", 
                    getAgentEmoji(type), type.getCode().toUpperCase()));
            }
        }
        
        stats.append("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n");
        
        return stats.toString();
    }
    
    private String getAgentEmoji(AgentType type) {
        return switch (type) {
            case STORY -> "üìö";
            case MATH -> "üî¢";
            case DROIT -> "‚öñÔ∏è";
//            case GENERAL -> "ü§ñ";
            case GUARD -> "üõ°Ô∏è";
        };
    }
    
    private DocumentAnalyser createAgentDocumentAnalyser(String documentDirectory, ServiceFactory serviceFactory) {
        try {
            return new org.rag_sys.orchestrator.RagSystemOrchestrator(configuration)
                    .registerRagChainForDifferentAgents(documentDirectory, serviceFactory, configuration);
        } catch (Exception e) {
            System.err.println("Erreur lors de la cr√©ation de l'analyseur de documents: " + e.getMessage());
            return null;
        }
    }
    
    private String formatRejectionResponse(QuestionAnalysisResult analysis) {
        return String.format("""
            üö´ **Question Rejet√©e par l'Agent de Garde**
            
            ‚ùå **Raison du rejet :**
            %s
            
            üìä **Score de confiance :** %.2f/1.0 (Seuil minimum: 0.30)
            
            üí° **Suggestions :**
            ‚Ä¢ Reformulez votre question de mani√®re plus claire et pr√©cise
            ‚Ä¢ Assurez-vous que votre question est appropri√©e et respectueuse
            ‚Ä¢ V√©rifiez que votre question entre dans l'un de nos domaines d'expertise :
              üìö Histoires et r√©cits  üî¢ Math√©matiques  ‚öñÔ∏è Droit  ü§ñ Questions g√©n√©rales
            
            ‚ùì Tapez 'help' pour plus d'informations sur l'utilisation du syst√®me.
            """, analysis.getReasoning(), analysis.getConfidenceScore());
    }
    
    private String formatAgentUnavailableResponse(AgentType agentType) {
        return String.format("""
            ‚ö†Ô∏è **Agent Temporairement Indisponible**
            
            L'agent sp√©cialis√© **%s** (%s) n'est pas disponible actuellement.
            
            üîß **Causes possibles :**
            ‚Ä¢ Agent en cours d'initialisation
            ‚Ä¢ Probl√®me de connexion avec la base de donn√©es
            ‚Ä¢ Erreur lors du chargement des documents
            
            üîÑ **Solutions :**
            ‚Ä¢ R√©essayez dans quelques instants
            ‚Ä¢ Reformulez votre question pour qu'elle soit trait√©e par un autre agent
            ‚Ä¢ Contactez l'administrateur si le probl√®me persiste
            
            üìä Tapez 'stats' pour voir l'√©tat de tous les agents.
            """, 
            agentType.getCode().toUpperCase(), 
            agentType.getDescription());
    }
    
    private String formatErrorResponse(Exception error) {
        return String.format("""
            üí• **Erreur Syst√®me**
            
            Une erreur inattendue s'est produite lors du traitement de votre question.
            
            üîç **D√©tails techniques :**
            %s
            
            üõ†Ô∏è **Actions recommand√©es :**
            ‚Ä¢ R√©essayez votre question
            ‚Ä¢ V√©rifiez que votre question est bien form√©e
            ‚Ä¢ Si le probl√®me persiste, contactez l'administrateur
            
            üìù L'erreur a √©t√© enregistr√©e pour analyse.
            """, error.getMessage());
    }
    
    private String formatSuccessResponse(QuestionAnalysisResult analysis, String response) {
        return String.format("""
            ü§ñ **R√©ponse de l'Agent %s** (Confiance: %.1f%%)
            
            %s
            
            ---
            üí° *Cette r√©ponse a √©t√© g√©n√©r√©e par l'agent sp√©cialis√© en %s*
            """, 
            analysis.getRecommendedAgent().getCode().toUpperCase(),
            analysis.getConfidenceScore() * 100,
            response,
            analysis.getRecommendedAgent().getDescription().toLowerCase());
    }
}
